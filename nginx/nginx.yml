---
- hosts: master
  remote_user: "{{ ansible_remote_user }}"
  gather_facts: False

  tasks:

  - name: Launch ngix pods
    command: "kubectl create deployment nginx --image nginx"

  - name: Expose nginx
    command: "kubectl expose deployment nginx --port 80 --target-port 80 --type NodePort"

  - name: Get exposed port
    command: "kubectl get svc nginx --output=jsonpath='{range .spec.ports[0]}{.nodePort}'"
    register: result

  - set_fact:
      node_port: "{{ result.stdout }}"

  - debug: msg="Exposed port {{ node_port }}"

